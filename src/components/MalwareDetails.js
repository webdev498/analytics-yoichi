import React, {PropTypes} from 'react';
import {Colors} from 'theme/colors';

import Reactable from 'reactable';
import {baseUrl} from 'config';
const {Table, Thead, Th, Tr, Td} = Reactable;

const styles = {
  card: {
    display: 'flex',
    flexDirection: 'column'
  },
  list: {
    listStyleType: 'none',
    fontSize: '13px',
    width: '100%',
    padding: 0,
    margin: 0,
    marginBottom: '33px'
  },
  heading: {
    backgroundColor: Colors.smoke
  },
  title: {
    margin: 0,
    border: 0
  },
  itemTitle: {
    margin: 0,
    fontWeight: 'bold',
    minWidth: '100px',
    display: 'inline-block'
  },
  item: {
    padding: '15px',
    borderBottom: '1px solid ' + Colors.smoke
  },
  buttonWrap: {
    textAlign: 'right',
    marginTop: '25px',
    marginRight: '20px'
  },
  button: {
    fontWeight: 300,
    position: 'relative',
    fontSize: '14px',
    textTransform: 'uppercase',
    paddingLeft: '16px',
    paddingRight: '16px',
    boxSizing: 'border-box',
    display: 'inline-block',
    backgroundColor: Colors.pebble,
    color: Colors.navigation,
    textDecoration: 'none',
    minWidth: '88px',
    height: '36px',
    lineHeight: '36px'
  }
};

class MalwareDetails extends React.Component {
  static propTypes = {
    data: PropTypes.object
  }

  _wrapInLi(input) {
    return input.map((item, index) => {
      return (
        <li style={styles.item} key={index}>
          <span style={styles.itemTitle}>{item.title}</span>
          <span style={styles.itemText}>{item.text}</span>
        </li>
      );
    });
  }

  getFileDetails(data) {
    const file = data.file;
    const fileInfo = [];

    fileInfo.push({title: 'File Name', text: file.fileName});
    fileInfo.push({title: 'File Hash', text: file.sha256});

    return this._wrapInLi(fileInfo);
  }

  getRiskCategory(malwareData) {
    const threats = malwareData.cuckoo.extra.threats;

    return threats.map((threat, index) => {
      return (
        <Tr key={index}>
          <Td column='description'>
            {threat.description}
          </Td>
          <Td column='severity'>
            {threat.severity}
          </Td>
        </Tr>
      );
    });
  }

  _getTableRows(hosts) {
    return hosts.map((host, index) => {
      let country = host.country ? host.country.toLowerCase() : '';
      return (
        <Tr key={index}>
          <Td column='ip'>
            {host.ip}
          </Td>
          <Td column='port'>
            {host.port}
          </Td>
          <Td column='whois'>
            <a href={'http://whois.domaintools.com/' + host.ip} target='_blank'>
              {host.ip}
            </a>
          </Td>
          <Td column='country'>
            <span>
              <span>{host.country}</span> &nbsp;
              <span className={'flag-icon flag-icon-' + country}></span>
            </span>
          </Td>
        </Tr>
      );
    });
  }

  getTable(malwareData) {
    const hosts = malwareData.cuckoo.extra.hosts;

    return (
      <Table style={{width: '100%'}}
        className='threatTable'
        pageButtonLimit={5}
        currentPage={0}
        itemsPerPage={hosts.length > 5 ? 5 : 0}>
        <Thead>
          <Th style={{backgroundColor: Colors.smoke}} column='ip'><b>IP</b></Th>
          <Th style={{backgroundColor: Colors.smoke}} column='port'><b>Port</b></Th>
          <Th style={{backgroundColor: Colors.smoke}} column='whois'><b>Whois</b></Th>
          <Th style={{backgroundColor: Colors.smoke}} column='country'><b>Country</b></Th>
        </Thead>
        {this._getTableRows(hosts)}
      </Table>
    );
  }

  getUrl(data) {
    return `${baseUrl}/api/sandbox/cuckoo/${data.file.sha256}`;
  }

  render() {
    const {data} = this.props;

    let malwareData = null;

    if (data && data.rows && data.rows[0] && data.rows[0][0] && data.rows[0][0].data && data.rows[0][0].data.report) {
      malwareData = data.rows[0][0].data.report;
    }
    else {
      return null;
    }

    return (
      <div style={styles.card}>
        <ul style={styles.list}>
          <li style={{...styles.heading, ...styles.item}}>
            <h4 style={styles.title}>File Details</h4>
          </li>
          {this.getFileDetails(malwareData)}
        </ul>

        {
          malwareData.cuckoo
          ? (
            <Table style={{width: '100%'}}
              className='threatTable'
              pageButtonLimit={5}
              currentPage={0}
              itemsPerPage={malwareData.cuckoo.extra.threats.length > 5 ? 5 : 0}>
              <Thead>
                <Th style={{backgroundColor: Colors.smoke}} column='description'><b>Description</b></Th>
                <Th style={{backgroundColor: Colors.smoke}} column='severity'><b>Severity</b></Th>
              </Thead>
              {this.getRiskCategory(malwareData)}
            </Table>
          )
          : null
        }

        {
          malwareData.cuckoo
          ? this.getTable(malwareData)
          : null
        }

        <div style={styles.buttonWrap}>
          <a
            style={styles.button}
            backgroundColor={Colors.pebble}
            labelColor={Colors.navigation}
            href={this.getUrl(malwareData)}
            target='_blank'>
            View Full Report
          </a>
        </div>
      </div>
    );
  }
}

export default MalwareDetails;
